name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Permite executar manualmente

env:
  AZURE_WEBAPP_NAME: mapa-app-clean-8270
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Verify secret is configured
        run: |
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "‚ùå ERROR: Secret AZURE_WEBAPP_PUBLISH_PROFILE is not configured!"
            echo ""
            echo "Please follow these steps:"
            echo "1. Get publish profile: az webapp deployment list-publishing-profiles --resource-group mapa-saas-clean --name mapa-app-clean-8270 --xml"
            echo "2. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "3. Create secret named: AZURE_WEBAPP_PUBLISH_PROFILE"
            echo "4. Paste the XML output"
            exit 1
          fi
          echo "‚úì Secret is configured"

      - name: üêç Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Create deployment package
        run: |
          echo "Creating deployment package..."
          zip -r deploy.zip . \
            -x "*.git*" \
            -x "*__pycache__*" \
            -x "*.pyc" \
            -x "*venv/*" \
            -x "*antenv/*" \
            -x "*.env" \
            -x "*uploads/*" \
            -x "*EXEMPLO-DO-PROJETO/*" \
            -x "deploy.zip" \
            -x "*.md" \
            -q

          ZIP_SIZE=$(du -h deploy.zip | cut -f1)
          echo "‚úì Package created: $ZIP_SIZE"

          # Verify zip was created
          if [ ! -f deploy.zip ]; then
            echo "‚ùå Failed to create deploy.zip"
            exit 1
          fi

      - name: üöÄ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy.zip

      - name: ‚úÖ Deployment complete
        run: |
          echo "============================================"
          echo "‚úÖ Deployment completed successfully!"
          echo "============================================"
          echo ""
          echo "App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "Health: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo ""
          echo "‚è≥ First startup may take 3-5 minutes"
          echo "   (Oryx is installing dependencies...)"
          echo ""
