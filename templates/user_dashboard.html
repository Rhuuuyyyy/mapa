{% extends "base.html" %}

{% block title %}Dashboard - MAPA SaaS{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>Meu Painel</h2>
        <div class="user-info">
            <span id="userName"></span>
            <button onclick="logout()" class="btn btn-secondary">Sair</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('uploads')">Uploads</button>
        <button class="tab-button" onclick="showTab('catalog')">Catálogo</button>
        <button class="tab-button" onclick="showTab('reports')">Relatórios</button>
    </div>

    <div class="dashboard-content">
        <!-- TAB: UPLOADS -->
        <section id="tab-uploads" class="tab-content active">
            <h3>Upload de XMLs/PDFs</h3>

            <div class="upload-section">
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="fileInput">Selecione arquivo XML ou PDF:</label>
                        <input type="file" id="fileInput" accept=".xml,.pdf" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Fazer Upload</button>
                </form>
            </div>

            <div class="uploads-list">
                <h4>Meus Uploads</h4>
                <div id="uploadsList"></div>
            </div>
        </section>

        <!-- TAB: CATÁLOGO -->
        <section id="tab-catalog" class="tab-content">
            <h3>Catálogo de Empresas e Produtos</h3>

            <div class="catalog-actions">
                <button onclick="showAddCompanyForm()" class="btn btn-primary">+ Adicionar Empresa</button>
                <button onclick="showAddProductForm()" class="btn btn-primary">+ Adicionar Produto</button>
            </div>

            <div id="addCompanyForm" class="form-container" style="display: none;">
                <h4>Nova Empresa</h4>
                <form id="newCompanyForm">
                    <div class="form-group">
                        <label for="companyName">Nome da Empresa</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label for="companyMapa">Registro MAPA (ex: PR-12345)</label>
                        <input type="text" id="companyMapa" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" onclick="hideAddCompanyForm()" class="btn btn-secondary">Cancelar</button>
                </form>
            </div>

            <div id="addProductForm" class="form-container" style="display: none;">
                <h4>Novo Produto</h4>
                <form id="newProductForm">
                    <div class="form-group">
                        <label for="productCompany">Empresa</label>
                        <select id="productCompany" required></select>
                    </div>
                    <div class="form-group">
                        <label for="productName">Nome do Produto</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productMapa">Registro MAPA (ex: 6.000001)</label>
                        <input type="text" id="productMapa" required>
                    </div>
                    <div class="form-group">
                        <label for="productRef">Referência (Opcional)</label>
                        <input type="text" id="productRef">
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" onclick="hideAddProductForm()" class="btn btn-secondary">Cancelar</button>
                </form>
            </div>

            <div id="catalogContent"></div>
        </section>

        <!-- TAB: RELATÓRIOS -->
        <section id="tab-reports" class="tab-content">
            <h3>Gerar Relatório MAPA</h3>

            <div class="report-form">
                <form id="reportForm">
                    <div class="form-group">
                        <label for="reportPeriod">Período (ex: Q1-2025)</label>
                        <input type="text" id="reportPeriod" pattern="^Q[1-4]-\d{4}$" placeholder="Q1-2025" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Gerar Relatório</button>
                </form>
            </div>

            <div id="reportResult"></div>
        </section>
    </div>
</div>

<script>
// Variável global para armazenar o token
let token = localStorage.getItem('access_token');

// Funções de tabs
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'uploads') loadUploads();
    if (tabName === 'catalog') loadCatalog();
}

// Logout
function logout() {
    localStorage.removeItem('access_token');
    window.location.href = '/login.html';
}

// Verificar autenticação
async function checkAuth() {
    if (!token) {
        window.location.href = '/login.html';
        return;
    }

    try {
        const response = await fetch('/api/admin/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Not authenticated');

        const user = await response.json();
        document.getElementById('userName').textContent = user.full_name;

    } catch (error) {
        localStorage.removeItem('access_token');
        window.location.href = '/login.html';
    }
}

// Upload de arquivo
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('fileInput');
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/api/user/upload', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (!response.ok) throw new Error('Erro ao fazer upload');

        alert('Upload realizado com sucesso!');
        fileInput.value = '';
        loadUploads();

    } catch (error) {
        alert('Erro: ' + error.message);
    }
});

// Carregar uploads
async function loadUploads() {
    try {
        const response = await fetch('/api/user/uploads', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const uploads = await response.json();
        const listDiv = document.getElementById('uploadsList');

        if (uploads.length === 0) {
            listDiv.innerHTML = '<p>Nenhum upload ainda.</p>';
            return;
        }

        listDiv.innerHTML = uploads.map(upload => `
            <div class="upload-item">
                <strong>${upload.filename}</strong> - ${upload.status}
                ${upload.error_message ? `<br><span class="error">${upload.error_message}</span>` : ''}
            </div>
        `).join('');

    } catch (error) {
        console.error('Erro ao carregar uploads:', error);
    }
}

// Carregar catálogo
async function loadCatalog() {
    try {
        const response = await fetch('/api/user/catalog', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const catalog = await response.json();
        const contentDiv = document.getElementById('catalogContent');

        contentDiv.innerHTML = `
            <div class="catalog-summary">
                <p><strong>Total de Empresas:</strong> ${catalog.total_companies}</p>
                <p><strong>Total de Produtos:</strong> ${catalog.total_products}</p>
            </div>
            ${catalog.companies.map(company => `
                <div class="company-card">
                    <h4>${company.company_name}</h4>
                    <p>Registro MAPA: ${company.mapa_registration}</p>
                    <div class="products-list">
                        ${company.products.map(product => `
                            <div class="product-item">
                                ${product.product_name} - ${product.mapa_registration}
                                ${product.product_reference ? ` (${product.product_reference})` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        `;

        // Carregar empresas no select de produtos
        const select = document.getElementById('productCompany');
        select.innerHTML = '<option value="">Selecione...</option>' +
            catalog.companies.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');

    } catch (error) {
        console.error('Erro ao carregar catálogo:', error);
    }
}

// Forms de catálogo
function showAddCompanyForm() {
    document.getElementById('addCompanyForm').style.display = 'block';
}

function hideAddCompanyForm() {
    document.getElementById('addCompanyForm').style.display = 'none';
    document.getElementById('newCompanyForm').reset();
}

function showAddProductForm() {
    document.getElementById('addProductForm').style.display = 'block';
}

function hideAddProductForm() {
    document.getElementById('addProductForm').style.display = 'none';
    document.getElementById('newProductForm').reset();
}

// Inicializar
checkAuth();
loadUploads();
</script>
{% endblock %}
