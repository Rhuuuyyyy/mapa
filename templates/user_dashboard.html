{% extends "base.html" %}

{% block title %}Dashboard - MAPA SaaS{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <h1>üìä Meus Relat√≥rios MAPA</h1>
        <div class="header-actions">
            <span class="user-badge" id="userName">Carregando...</span>
            <button onclick="logout()" class="btn btn-secondary">Sair</button>
        </div>
    </header>
    
    <div class="dashboard-content">
        <!-- Raw Material Catalog Section -->
        <div class="catalog-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">üìö</span>
                    <h2>Cat√°logo Mestre de Mat√©rias-Primas</h2>
                </div>
                <div>
                    <button onclick="showAddCatalogModal()" class="btn btn-success">
                        <span>‚ûï</span> Adicionar Produto
                    </button>
                </div>
            </div>

            <div class="alert alert-info" style="margin-bottom: 20px;">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <div class="alert-content">
                    <h4>Como funciona o Cat√°logo</h4>
                    <p>Mapeie os nomes dos produtos (exatamente como aparecem no XML) para seus n√∫meros de registro MAPA. Isso garante processamento confi√°vel sem erros de extra√ß√£o autom√°tica.</p>
                </div>
            </div>

            <table id="catalogTable">
                <thead>
                    <tr>
                        <th style="width: 40%;">Nome do Produto (XML)</th>
                        <th style="width: 25%;">Registro MAPA</th>
                        <th style="width: 25%;">Refer√™ncia</th>
                        <th style="width: 10%;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="catalogTableBody">
                    <tr>
                        <td colspan="4" class="loading">
                            <div class="spinner"></div> Carregando cat√°logo...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Info Cards -->
        <div class="info-cards">
            <div class="info-card">
                <div class="info-card-header">
                    <span class="info-card-icon">üìÑ</span>
                    <h3>Upload de NF-e</h3>
                </div>
                <p>Fa√ßa upload de suas Notas Fiscais Eletr√¥nicas nos formatos XML ou PDF (DANFE) para processamento autom√°tico.</p>
                <ul>
                    <li>‚úÖ Suporta XML de NF-e</li>
                    <li>‚úÖ Suporta PDF da DANFE</li>
                    <li>‚úÖ Extra√ß√£o autom√°tica de dados</li>
                </ul>
            </div>
            
            <div class="info-card">
                <div class="info-card-header">
                    <span class="info-card-icon">‚öôÔ∏è</span>
                    <h3>Processamento</h3>
                </div>
                <p>Os arquivos s√£o processados automaticamente ap√≥s o upload, extraindo todas as informa√ß√µes relevantes.</p>
                <ul>
                    <li>üì¶ Dados do produto e garantias</li>
                    <li>üè¢ Emitente e destinat√°rio</li>
                    <li>üí∞ Valores e quantidades</li>
                </ul>
            </div>
            
            <div class="info-card">
                <div class="info-card-header">
                    <span class="info-card-icon">üìä</span>
                    <h3>Relat√≥rio MAPA</h3>
                </div>
                <p>Gere o relat√≥rio trimestral no formato oficial do MAPA com um clique.</p>
                <ul>
                    <li>üìã Formato padr√£o MAPA</li>
                    <li>üì• Download em Excel (.xlsx)</li>
                    <li>‚úÖ Pronto para envio</li>
                </ul>
            </div>
        </div>
        
        <!-- Upload Section -->
        <div class="upload-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">üì§</span>
                    <h2>Upload de NF-e</h2>
                </div>
            </div>
            
            <div class="upload-box">
                <span class="upload-icon">üìÑ</span>
                <h3>Arraste ou selecione seus arquivos</h3>
                <p>Aceita arquivos XML ou PDF de Nota Fiscal Eletr√¥nica</p>
                <form id="uploadForm">
                    <input type="file" id="xmlFile" accept=".xml,.pdf" required>
                    <button type="submit" class="btn btn-primary">
                        <span>üì§</span> Enviar Arquivo
                    </button>
                </form>
                <div id="uploadStatus" class="status-message" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Uploads Section -->
        <div class="uploads-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">üìã</span>
                    <h2>Arquivos Enviados</h2>
                </div>
                <div>
                    <span id="uploadCount" class="badge badge-primary">0 arquivos</span>
                </div>
            </div>
            
            <table id="uploadsTable">
                <thead>
                    <tr>
                        <th>Arquivo</th>
                        <th>Tipo</th>
                        <th>Data de Upload</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="uploadsTableBody">
                    <tr>
                        <td colspan="5" class="loading">
                            <div class="spinner"></div> Carregando uploads...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Generate Report Section -->
        <div class="upload-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">üéØ</span>
                    <h2>Gerar Relat√≥rio Trimestral MAPA</h2>
                </div>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <div class="alert-content">
                    <h4>Como gerar o relat√≥rio</h4>
                    <p>Selecione o trimestre desejado e clique em "Gerar Relat√≥rio". O sistema ir√° processar todos os arquivos enviados e criar uma tabela de resumo para facilitar o preenchimento do relat√≥rio MAPA.</p>
                </div>
            </div>

            <form id="generateReportForm" style="max-width: 500px; margin: 20px auto;">
                <div class="form-group">
                    <label for="reportPeriod">Selecione o Trimestre</label>
                    <select id="reportPeriod" required style="width: 100%; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; background: white;">
                        <option value="">-- Selecione --</option>
                        <option value="Q1-2025">1¬∫ Trimestre 2025 (Jan-Mar)</option>
                        <option value="Q2-2025">2¬∫ Trimestre 2025 (Abr-Jun)</option>
                        <option value="Q3-2025">3¬∫ Trimestre 2025 (Jul-Set)</option>
                        <option value="Q4-2025">4¬∫ Trimestre 2025 (Out-Dez)</option>
                        <option value="Q1-2024">1¬∫ Trimestre 2024 (Jan-Mar)</option>
                        <option value="Q2-2024">2¬∫ Trimestre 2024 (Abr-Jun)</option>
                        <option value="Q3-2024">3¬∫ Trimestre 2024 (Jul-Set)</option>
                        <option value="Q4-2024">4¬∫ Trimestre 2024 (Out-Dez)</option>
                    </select>
                </div>

                <div id="generateStatus" class="status-message" style="display: none;"></div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span>üìä</span> Processar Arquivos
                </button>
            </form>

            <!-- Report Results Section -->
            <div id="reportResultsSection" style="display: none; margin-top: 30px;">
                <div class="section-header" style="margin-bottom: 20px;">
                    <div class="section-title">
                        <span class="section-icon">üìã</span>
                        <h3>Resultado do Processamento</h3>
                    </div>
                    <div>
                        <button onclick="exportToPDF()" class="btn btn-success">
                            <span>üìÑ</span> Exportar para PDF
                        </button>
                    </div>
                </div>

                <div class="alert alert-success" style="margin-bottom: 20px;">
                    <span class="alert-icon">‚úÖ</span>
                    <div class="alert-content">
                        <p id="reportResultsSummary">Processamento conclu√≠do com sucesso!</p>
                    </div>
                </div>

                <table id="reportResultsTable" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Registro MAPA</th>
                            <th style="width: 30%;">Produto (Refer√™ncia)</th>
                            <th style="width: 10%;">Unidade</th>
                            <th style="width: 15%;">Qtd. Importa√ß√£o</th>
                            <th style="width: 20%;">Qtd. Outras Entradas (Mercado Nacional)</th>
                        </tr>
                    </thead>
                    <tbody id="reportResultsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Unregistered Products Error Section -->
            <div id="unregisteredProductsSection" style="display: none; margin-top: 30px;">
                <div class="alert alert-danger">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div class="alert-content">
                        <h4>Produtos N√£o Cadastrados no Cat√°logo</h4>
                        <p>Os seguintes produtos foram encontrados nos XMLs mas n√£o est√£o cadastrados no seu Cat√°logo de Mat√©rias-Primas. Por favor, adicione-os ao cat√°logo e processe novamente.</p>
                    </div>
                </div>

                <table id="unregisteredProductsTable" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Nome do Produto (XML)</th>
                            <th style="width: 20%;">NF-e</th>
                            <th style="width: 15%;">Quantidade</th>
                            <th style="width: 15%;">Unidade</th>
                        </tr>
                    </thead>
                    <tbody id="unregisteredProductsTableBody">
                    </tbody>
                </table>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="showAddCatalogModal()" class="btn btn-success">
                        <span>‚ûï</span> Adicionar Produtos ao Cat√°logo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/user.js"></script>
{% endblock %}