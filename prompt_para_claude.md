5a. Technical Specification for Aggregation Logic

To be perfectly clear, the data for the final PDF table must be generated by following this exact aggregation and unit conversion logic.

// ---
// 1. Data Structures
// ---

// MasterCatalog: A map (dictionary) managed by the user.
// Key: <xProd> (String, e.g., "CLORETO DE POTASSIO GRANEL")
// Value: Full MAPA Reg. (String, e.g., "RS-003295-9.000007")
MasterCatalog = {
  "CLORETO DE POTASSIO GRANEL": "RS-003295-9.000007",
  "SUPERFOSFATO SIMPLES - SSP P...": "SP 80894-0.000007",
  ...
}

// FinalTableData: The in-memory structure to aggregate results.
// Key: Full MAPA Reg. (String)
// Value: An object storing the totals.
FinalTableData = {}

// ErrorList: A list of strings to report missing items.
ErrorList = []

// ---
// 2. Unit Conversion Function
// ---

FUNCTION convert_to_tonnes(quantity, unit):
  IF unit == "TN":
    RETURN quantity
  ELSE IF unit == "KG":
    RETURN quantity / 1000.0
  ELSE:
    // Handle other units if necessary, or report an error
    Log.Warn("Unknown unit " + unit + ". Assuming KG.")
    RETURN quantity / 1000.0
  END IF
END FUNCTION

// ---
// 3. Main Processing Logic
// ---

// Loop through each XML file provided by the user
FOR EACH xml_file IN user_uploaded_files:

  // Loop through each product item in the XML
  FOR EACH item IN xml_file.findAll("<det>"):
  
    // 1. Get the Key from XML
    key_xProd = item.find("<prod><xProd>").text
    
    // 2. Query the Master Catalog
    mapa_reg_key = MasterCatalog.lookup(key_xProd)
    
    // 3. Handle Errors (Critical)
    IF mapa_reg_key IS NULL:
      nfe_number = xml_file.find("<ide><nNF>").text
      error_message = "Product '" + key_xProd + "' (from NFe " + nfe_number + ") was not found in your Master Catalog. Please add it."
      IF error_message NOT IN ErrorList:
         ErrorList.add(error_message)
      END IF
      CONTINUE // Skip this item
    END IF
    
    // 4. Extract Data
    quantity = float(item.find("<prod><qCom>").text)
    unit = item.find("<prod><uCom>").text
    
    // 5. Classify Entry Type
    is_import = xml_file.find("<emit><UF>").text == "EX"
    
    // 6. Initialize Aggregation Object (if first time seeing this product)
    IF mapa_reg_key NOT IN FinalTableData:
      FinalTableData[mapa_reg_key] = {
        "reference_name": key_xProd, // Store the first name we find
        "unit": "Tonelada", // Final report is always in Toneladas
        "import_qty": 0.0,
        "other_entry_qty": 0.0
      }
    END IF
    
    // 7. Convert and Aggregate
    quantity_in_tonnes = convert_to_tonnes(quantity, unit)
    
    IF is_import:
      FinalTableData[mapa_reg_key].import_qty += quantity_in_tonnes
    ELSE:
      FinalTableData[mapa_reg_key].other_entry_qty += quantity_in_tonnes
    END IF
    
  END FOR
END FOR

// ---
// 4. Final Output Generation
// ---

IF ErrorList IS NOT EMPTY:
  // If there are errors, DO NOT show the table.
  // Show the ErrorList to the user so they can fix the catalog.
  OUTPUT ErrorList
ELSE:
  // If no errors, build the PDF table.
  // The table format is exactly as specified:
  // | MAPA Registration No. | Product (Reference) | Unit | Quantity (Import) | Quantity (Other Entries) |
  
  FOR EACH mapa_reg, data IN FinalTableData:
    pdf.add_row(
      mapa_reg,
      data.reference_name,
      data.unit,
      format_number(data.import_qty),
      format_number(data.other_entry_qty)
    )
  END FOR
  
  OUTPUT PDF
END IF
